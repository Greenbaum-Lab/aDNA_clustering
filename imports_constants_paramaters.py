import os
os.environ["OMP_NUM_THREADS"] = "1"
os.environ["MKL_NUM_THREADS"] = "1"
os.environ["NUMEXPR_NUM_THREADS"] = "1"
os.environ["OPENBLAS_NUM_THREADS"] = "1"
import numpy as np
from sklearn.decomposition import PCA
import pandas as pd
from sklearn.cluster import KMeans
from sklearn.preprocessing import StandardScaler, LabelEncoder
from typing import Optional
import json
from collections import defaultdict, Counter
from scipy.stats import mode
from joblib import Parallel, delayed
import itertools
import concurrent.futures
import warnings
warnings.filterwarnings("ignore", category=FutureWarning)
import matplotlib.pyplot as plt
import matplotlib.patches as patches
from matplotlib.patches import Ellipse
import pickle
import os


# --- Index constants for data structure referencing ---
SIZES = 0        # Historical population sizes
FREQS = 1        # Historical allele frequencies
CUR_SIZE = 2     # Current population size
CUR_FREQS = 3    # Current allele frequencies
START_GEN = 4    # Generation at which the population began
AREA = 5         # Geographic area of the population

# --- Indices for event parameters ---
SRC_POP = 0      # Source population index
TGT_POP = 1      # Target population index
MIG_GEN = 2      # Migration starting generation
MIG_SIZE = 3     # Fraction of source pop migrating per step
MIG_LENGTH = 4   # Duration of migration in generations
SPLIT_GEN = 1    # Generation of population split
RPC_GEN = 2      # Generation of replacement

# --- Simulation parameters ---
generations = 400
generation_step = 25
num_of_populations = 5
min_population_size = 500
max_population_size = 1500
POP_SIZE = 750              # Fixed pop size if not using random range
pop_growth_factor = 1        # Growth multiplier per generation

sigma = 0.1              # Std deviation for sampling allele freq

num_of_variants = 500   # Number of simulated SNPs/loci
frequency_threshold = 0.01   # Threshold for filtering rare/common alleles

mutation_rate = 0.0001
num_of_samples = 2500
fst_generations = [0, 200, 400]  # Time points to compute Fst

# --- Area time weights - 100 years binns, 400 generations, 25 years per generation ---
areas_time_weights = {
    's_europe': (0,0,0,0.00177725118483412,0.00888625592417062,0.0154028436018957,0.0242890995260664,0.0260663507109005,0.0302132701421801,0.037914691943128,0.0622037914691943,0.0699052132701422,0.0835308056872038,0.136255924170616,0.162914691943128,0.19845971563981,0.21978672985782,0.237559241706161,0.278436018957346,0.289099526066351,0.29324644549763,0.300355450236967,0.330568720379147,0.347156398104265,0.380331753554502,0.39218009478673,0.410545023696683,0.420023696682465,0.422985781990521,0.42654028436019,0.428909952606635,0.43542654028436,0.437796208530806,0.440758293838863,0.445497630331754,0.45675355450237,0.475118483412322,0.497037914691943,0.52132701421801,0.562796208530806,0.58175355450237,0.600710900473934,0.647511848341232,0.684834123222749,0.697274881516588,0.712085308056872,0.727488151658768,0.74585308056872,0.761255924170616,0.783175355450237,0.790876777251185,0.802725118483412,0.811611374407583,0.811611374407583,0.816943127962085,0.819905213270142,0.82345971563981,0.825829383886256,0.828791469194313,0.830568720379147,0.837085308056872,0.866113744075829,0.869668246445497,0.875,0.880331753554502,0.893364928909952,0.906398104265402,0.913507109004739,0.917061611374407,0.924763033175355,0.937203791469194,0.969194312796208,0.977488151658767,0.978080568720379,0.981042654028436,0.98281990521327,0.986374407582938,0.989336492890995,0.991113744075829,0.992298578199052,0.995260663507109,0.995260663507109,0.995260663507109,0.99585308056872,0.99585308056872,0.99585308056872,0.99585308056872,0.99585308056872,0.99585308056872,0.99585308056872,0.99585308056872,0.999407582938388,1,1,1,1,1,1,1,1),
    'britain': (0.34887839433294,0.34887839433294,0.34887839433294,0.34887839433294,0.34887839433294,0.34887839433294,0.34887839433294,0.34887839433294,0.352420306965761,0.355371900826446,0.400236127508855,0.402597402597403,0.462219598583235,0.471664698937426,0.496458087367178,0.533057851239669,0.533648170011806,0.533648170011806,0.541912632821724,0.548996458087367,0.567296340023613,0.595041322314049,0.680047225501771,0.710153482880756,0.71900826446281,0.724911452184179,0.735537190082645,0.735537190082645,0.743801652892562,0.752656434474616,0.755017709563164,0.759149940968123,0.762691853600944,0.770365997638725,0.78866587957497,0.793388429752066,0.796930342384888,0.799291617473436,0.809327036599764,0.815230224321133,0.827626918536009,0.838252656434475,0.847107438016529,0.853600944510035,0.854191263282172,0.85655253837072,0.85655253837072,0.858323494687131,0.861275088547816,0.868358913813459,0.87012987012987,0.878984651711925,0.888429752066116,0.891381345926801,0.912042502951594,0.942739079102716,0.976387249114522,0.991735537190083,0.994687131050768,0.994687131050768,0.995277449822905,0.995277449822905,0.995277449822905,0.996458087367178,0.996458087367178,0.997048406139315,0.997048406139315,0.997638724911452,0.997638724911452,0.997638724911452,0.997638724911452,0.997638724911452,0.997638724911452,0.997638724911452,0.997638724911452,0.997638724911452,0.997638724911452,0.997638724911452,0.997638724911452,0.997638724911452,0.997638724911452,0.997638724911452,0.997638724911452,0.997638724911452,0.997638724911452,0.997638724911452,0.997638724911452,0.997638724911452,0.997638724911452,0.997638724911452,0.997638724911452,0.997638724911452,0.997638724911452,0.999409681227863,0.999409681227863,0.999409681227863,1,1,1,1),
    'asia': (0.388557806912992,0.390941597139452,0.394517282479142,0.396305125148987,0.423122765196663,0.470202622169249,0.48569725864124,0.520858164481526,0.523837902264601,0.525625744934446,0.528605482717521,0.538736591179976,0.546483909415972,0.554231227651967,0.562574493444577,0.569725864123957,0.601311084624553,0.603098927294398,0.613230035756854,0.626340882002384,0.643027413587605,0.65673420738975,0.679380214541121,0.689511323003576,0.693087008343266,0.697258641239571,0.711561382598332,0.720500595947557,0.731823599523242,0.747318235995233,0.753873659117998,0.762812872467224,0.773539928486294,0.787842669845054,0.792014302741359,0.797377830750895,0.798569725864125,0.802145411203815,0.808104886769965,0.81704410011919,0.825983313468416,0.831942789034566,0.842669845053636,0.856376638855782,0.863528009535162,0.875446960667462,0.886769964243147,0.895709177592373,0.901668653158523,0.904648390941598,0.907628128724673,0.914779499404053,0.915375446960669,0.921930870083434,0.922526817640049,0.924910607866509,0.930870083432659,0.932061978545889,0.933849821215734,0.933849821215734,0.936233611442194,0.937425506555424,0.938617401668654,0.940405244338499,0.940405244338499,0.940405244338499,0.944576877234805,0.948152562574495,0.951728247914185,0.95470798569726,0.95828367103695,0.960071513706795,0.96305125148987,0.96662693682956,0.970202622169251,0.975566150178786,0.978545887961861,0.981525625744936,0.985697258641241,0.988676996424316,0.988676996424316,0.988676996424316,0.990464839094161,0.991060786650777,0.993444576877237,0.993444576877237,0.994040524433852,0.994636471990467,0.995828367103697,0.995828367103697,0.996424314660312,0.997020262216927,0.998212157330157,0.998212157330157,0.998212157330157,0.998212157330157,0.998212157330157,0.998808104886772,0.999404052443387,1),
    'levant': (0.171704957678356,0.171704957678356,0.173518742442563,0.173518742442563,0.180773881499395,0.186819830713422,0.187424425634825,0.196493349455865,0.203748488512697,0.20677146311971,0.210399032648126,0.240628778718259,0.256952841596131,0.266021765417171,0.27509068923821,0.282950423216445,0.287787182587666,0.296251511487304,0.300483675937122,0.31136638452237,0.331318016928658,0.3409915356711,0.344014510278114,0.348246674727932,0.355501813784764,0.359733978234583,0.390568319226118,0.398428053204353,0.420798065296251,0.441958887545345,0.450423216444982,0.484280532043531,0.514510278113664,0.56590084643289,0.588270858524788,0.613059250302297,0.627569528415961,0.648730350665054,0.674123337363966,0.694074969770254,0.712817412333736,0.739419588875453,0.746674727932285,0.757557436517533,0.767230955259976,0.779322853688029,0.792019347037485,0.799274486094317,0.802902055622733,0.808948004836759,0.816203143893591,0.834340991535671,0.85006045949214,0.854897218863362,0.861547762998791,0.876662636033857,0.879081015719468,0.880894800483676,0.8863361547763,0.888149939540508,0.902660217654172,0.903869407496977,0.90447400241838,0.905078597339782,0.905078597339782,0.908101571946796,0.909310761789601,0.911124546553809,0.911124546553809,0.911729141475212,0.91354292623942,0.91354292623942,0.91354292623942,0.914147521160822,0.915356711003628,0.916565900846433,0.919588875453446,0.921402660217654,0.922007255139057,0.932285368802902,0.938331318016929,0.944981862152358,0.948004836759371,0.958887545344619,0.960701330108827,0.965538089480048,0.97037484885127,0.973397823458283,0.974607013301088,0.975816203143894,0.977629987908102,0.977629987908102,0.980048367593712,0.980652962515115,0.981257557436517,0.984280532043531,0.989117291414752,0.989117291414752,0.993954050785973,1),
    'america': (0.388822829964328,0.413793103448276,0.419143876337693,0.431034482758621,0.446492271105826,0.470273483947681,0.517835909631391,0.555291319857313,0.592152199762188,0.638525564803805,0.709274673008323,0.812128418549346,0.829369797859691,0.844827586206896,0.849583828775268,0.857907253269917,0.868608799048751,0.874554102259215,0.879310344827586,0.88525564803805,0.89179548156956,0.892984542211653,0.89833531510107,0.90487514863258,0.908442330558858,0.912604042806183,0.913793103448276,0.917954815695601,0.919143876337693,0.919143876337693,0.91973840665874,0.922116527942925,0.929845422116528,0.931034482758621,0.931034482758621,0.935196195005946,0.935196195005946,0.935196195005946,0.935790725326992,0.936979785969085,0.938168846611177,0.939952437574317,0.940546967895363,0.940546967895363,0.942925089179548,0.944708680142687,0.945303210463734,0.946492271105827,0.949464922711059,0.959571938168847,0.96076099881094,0.963733650416172,0.964922711058264,0.964922711058264,0.966111771700357,0.966706302021404,0.967895362663496,0.968489892984543,0.970868014268728,0.970868014268728,0.970868014268728,0.970868014268728,0.971462544589775,0.971462544589775,0.971462544589775,0.972057074910821,0.972651605231867,0.973246135552914,0.974435196195007,0.975029726516053,0.975029726516053,0.978596908442331,0.979785969084424,0.98038049940547,0.983353151010702,0.983353151010702,0.984542211652795,0.986325802615934,0.987514863258027,0.987514863258027,0.987514863258027,0.987514863258027,0.987514863258027,0.987514863258027,0.988109393579073,0.989298454221166,0.990487514863259,0.991082045184305,0.992271105826398,0.992271105826398,0.993460166468491,0.994054696789537,0.994649227110584,0.99524375743163,0.99524375743163,0.996432818073723,0.998810939357908,0.998810939357908,0.999405469678955,1),
    'step': (0.568731563421829,0.950442477876106,0.975221238938053,0.989380530973451,0.990560471976401,0.990560471976401,0.992920353982301,0.995870206489676,0.9976401179941,0.9976401179941,0.9976401179941,0.9976401179941,0.9976401179941,0.9976401179941,0.9976401179941,0.9976401179941,0.9976401179941,0.9976401179941,0.9976401179941,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,0.998230088495575,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1)
}
areas = ('s_europe','britain', 'asia', 'levant', 'america', 'step', 'unsample')

p_stay=0.33 #chance of sampling from same generation

p_mig_unsample = 0.05

# Initial split events for setting up populations at time 0
i_split1 = [0, 1]
i_split2 = [0, 2]
i_split3 = [1, 1]
init_splits = [i_split1, i_split3]


